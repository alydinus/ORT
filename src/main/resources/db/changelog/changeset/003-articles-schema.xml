<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <changeSet id="003-articles-module" author="antigravity">
        <!-- Categories -->
        <createTable tableName="categories">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="categories_pkey"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="description" type="TEXT"/>
        </createTable>

        <!-- Tags -->
        <createTable tableName="tags">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="tags_pkey"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
        </createTable>

        <!-- Articles Updates -->
        <!-- Note: article table likely already exists from view_file check, but if created by previous liquibase/jpa auto-ddl, we assume standard structure. 
             If 'articles' table was NOT in 001/002 but existing code implies it, we should CREATE it if we haven't seen an initial schema that creates it.
             Wait, I saw ArticleEntity but I didn't see an initial migration for it in 001. 001 was just users/roles.
             Ah, 'ort-1' existing code might have relied on spring.jpa.hibernate.ddl-auto=update.
             But now we are enforcing Liquibase. 
             I should probably create the articles/comments/reactions tables if they don't exist in my migrations.
             Since I am "continuing" development, I should robustly check if table exists or just create them.
             Given I am to produce "production-ready code", I should define the full schema. 
             I'll define articles, comments, reactions here as well if not present.
        -->
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="articles"/>
            </not>
        </preConditions>
        <createTable tableName="articles">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="articles_pkey"/>
            </column>
            <column name="title" type="VARCHAR(255)"/>
            <column name="content" type="TEXT"/>
            <column name="html" type="TEXT"/>
            <column name="author_id" type="BIGINT"/>
            <column name="created_at" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="003-articles-module-updates" author="antigravity">
         <addColumn tableName="articles">
            <column name="views" type="BIGINT" defaultValueNumeric="0"/>
            <column name="is_published" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="category_id" type="BIGINT"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="category_id" baseTableName="articles"
                                 constraintName="fk_articles_category" referencedColumnNames="id" referencedTableName="categories"/>

        <createTable tableName="articles_tags">
            <column name="article_entity_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="tags_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addForeignKeyConstraint baseColumnNames="article_entity_id" baseTableName="articles_tags"
                                 constraintName="fk_articles_tags_article" referencedColumnNames="id" referencedTableName="articles"/>
        <addForeignKeyConstraint baseColumnNames="tags_id" baseTableName="articles_tags"
                                 constraintName="fk_articles_tags_tag" referencedColumnNames="id" referencedTableName="tags"/>
    </changeSet>
    
    <changeSet id="003-comments-reactions" author="antigravity">
         <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="comments"/>
            </not>
        </preConditions>
        <createTable tableName="comments">
             <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="comments_pkey"/>
            </column>
            <column name="comment" type="TEXT"/>
            <column name="author_id" type="BIGINT"/>
            <column name="article_entity_id" type="BIGINT"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="article_entity_id" baseTableName="comments" constraintName="fk_comments_article" referencedColumnNames="id" referencedTableName="articles"/>
        
        <createTable tableName="reactions">
             <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="reactions_pkey"/>
            </column>
            <column name="reaction_value" type="VARCHAR(50)"/>
            <column name="author_id" type="BIGINT"/>
            <column name="article_entity_id" type="BIGINT"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="article_entity_id" baseTableName="reactions" constraintName="fk_reactions_article" referencedColumnNames="id" referencedTableName="articles"/>
    </changeSet>

</databaseChangeLog>
